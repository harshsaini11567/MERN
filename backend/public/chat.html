<!DOCTYPE html>
<html>

<head>
  <title>Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/socket.io/socket.io.js"></script>
</head>

<body class="bg-gray-100 h-screen flex">

  <!-- Sidebar -->
  <div class="w-1/4 bg-white border-r">
    <h2 class="p-4 font-bold text-xl border-b">Chats</h2>
    <ul id="users" class="p-4 space-y-2"></ul>
  </div>

  <!-- Chat Area -->
  <div class="flex-1 flex flex-col">
    <div class="bg-green-600 text-white p-4 font-semibold">
      Chat Window
    </div>

    <ul id="chat" class="flex-1 p-4 overflow-y-auto space-y-2"></ul>

    <div class="p-4 flex gap-2 border-t bg-white">
      <input id="msg" placeholder="Message" class="flex-1 p-2 border rounded">
      <button onclick="send()" class="bg-green-600 text-white px-4 rounded">
        Send
      </button>
    </div>
  </div>

  <script>
    // ================= AUTH CHECK =================
    const user = localStorage.getItem("user");
    if (!user) location.href = "/login";

    // ================= STATE =================
    let currentChatUser = null;
    let allUsers = [];
    let onlineUsers = [];

    // ================= SOCKET =================
    const socket = io();
    socket.emit("join", user);

    // ================= DOM =================
    const usersList = document.getElementById("users");
    const chatBox = document.getElementById("chat");

    // ================= HELPERS =================
    function getInitial(name) {
      return name.charAt(0).toUpperCase();
    }

    function getColor(name) {
      const colors = [
        "bg-purple-500", "bg-blue-500", "bg-green-500",
        "bg-pink-500", "bg-yellow-500", "bg-indigo-500", "bg-red-500"
      ];
      let hash = 0;
      for (let c of name) hash += c.charCodeAt(0);
      return colors[hash % colors.length];
    }

    // ================= FETCH USERS =================
    async function fetchAllUsers() {
      const res = await fetch("/users");
      allUsers = await res.json();
      renderUsers();
    }
    fetchAllUsers();

    // ================= ONLINE USERS =================
    socket.on("onlineUsers", users => {
      onlineUsers = users;
      renderUsers();
    });

    // ================= RENDER USERS =================
    function renderUsers() {
      usersList.innerHTML = "";

      allUsers.forEach(u => {
        if (u.username === user) return;

        const isOnline = onlineUsers.includes(u.username);

        const li = document.createElement("li");
        li.className =
          "flex items-center gap-3 p-2 rounded cursor-pointer hover:bg-gray-100";

        li.innerHTML = `
      <div class="relative">
        <div class="h-10 w-10 rounded-full flex items-center justify-center
          text-white font-bold ${getColor(u.username)}">
          ${getInitial(u.username)}
        </div>
        <span class="absolute bottom-0 right-0 h-3 w-3 rounded-full border-2 border-white
          ${isOnline ? "bg-green-500" : "bg-red-500"}"></span>
      </div>
      <span>${u.username}</span>
    `;

        li.onclick = () => selectUser(u.username);
        usersList.appendChild(li);
      });
    }

    // ================= LOAD CHAT =================
    async function selectUser(selectedUser) {
      currentChatUser = selectedUser;
      chatBox.innerHTML = "";

      const res = await fetch(`/messages/${user}/${selectedUser}`);
      const messages = await res.json();

      messages.forEach(m => {
        addMsg(m.sender === user ? "You" : m.sender, m.message);
      });
    }

    // ================= SEND MESSAGE =================
    function send() {
      if (!msg.value || !currentChatUser) return;

      socket.emit("sendMessage", {
        sender: user,
        receiver: currentChatUser,
        message: msg.value
      });

      addMsg("You", msg.value);
      msg.value = "";
    }

    // ================= RECEIVE MESSAGE =================
    socket.on("receiveMessage", data => {
      if (data.sender === currentChatUser) {
        addMsg(data.sender, data.message);
      }
    });

    // ================= ADD MESSAGE =================
    function addMsg(sender, message) {
      const isMe = sender === "You";

      const li = document.createElement("li");
      li.className = `flex ${isMe ? "justify-end" : "justify-start"} gap-2`;

      li.innerHTML = `
    ${!isMe ? `
      <div class="h-8 w-8 rounded-full flex items-center justify-center
        text-white text-sm font-bold ${getColor(sender)}">
        ${getInitial(sender)}
      </div>` : ""}
    <div class="px-4 py-2 rounded-lg max-w-xs
      ${isMe ? "bg-green-500 text-white" : "bg-white border"}">
      <b>${sender}:</b> ${message}
    </div>
  `;

      chatBox.appendChild(li);
      chatBox.scrollTop = chatBox.scrollHeight;
    }
  </script>

</body>

</html>